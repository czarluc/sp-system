{% extends "base.html" %}

{% block title %} Login {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

{% endblock stylesheets %}

{% block content %}
    <form class="form-horizontal" method="POST" action="">
        {% csrf_token %}

    <div class="card">
        <div class="card-header card-header-tabs card-header-info">
            <h4 class="card-title">Component Request Schedule Details:</h4>
        </div>
        <div class="card-body">
            <div class="form-row align-items-center">
                <div class="col-5">
                    <div class="form-group">
                        <label for="id_work_order_number">Part Request Issuance Schedule Number:</label>
                        <input type="text" name="partreqissuesched" class="form-control" maxlength="200" required="" id="partreqissuesched" readonly>
                    </div>
                </div>
                <div class="col-1">
		            <button class="btn btn-success add-partreqissuesched">+</button>
                </div>
                <div class="col-6">
                    <div class="form-group">
            	        <label for="id_customer">Date Scheduled:</label>
            	        <input type="text" name="date_sched" maxlength="200" class="form-control" required="" id="date_sched" readonly>
                   </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header card-header-tabs card-header-info">
            <h4 class="card-title">Required Part Request for Issuance:</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped w-auto" id="reqpart_table">
                    <thead class="thead-dark">
                        <tr class="tablehead">
                            <th scope="col">Schedule Number</th>
                            <th scope="col">Prod Sched ID</th>
                            <th scope="col">Item Number</th>
                            <th scope="col">Item Quantity</th>
                            <th scope="col">Bin Location ID</th>
                            <th scope="col">Bin Location</th>
                            <th scope="col">Assembly Line ID</th>
                            <th scope="col">Assembly Line</th>
                        </tr>
                    </thead>
                    <tbody>
                    	{% for reqpart in partreq_issuance_list %}
                        <div class="row form-row">
                            <tr class="tablerow part" id="reqpart-{{forloop.counter}}" data-sched_num="{{reqpart.schedule_num__schedule_num}}" data-prod_sched="{{reqpart.prod_sched__id}}" data-item_num="{{reqpart.item_number__item_number}}">
                                <td><input type="text" class="form-control" id="reqpart-{{forloop.counter}}-sched_num" value="{{reqpart.schedule_num__schedule_num}}" readonly="readonly"></td>
                                <td><input type="text" class="form-control" id="reqpart-{{forloop.counter}}-prod_sched" value="{{reqpart.prod_sched__id}}" readonly="readonly"></td>
                                <td><input type="text" class="form-control" id="reqpart-{{forloop.counter}}-item_num" value="{{reqpart.item_number__item_number}}" readonly="readonly"></td>
                                <td><input type="text" class="form-control" id="reqpart-{{forloop.counter}}-item_quan" value="{{reqpart.quantity}}" readonly="readonly"></td>
                                <td><input type="text" class="form-control" id="reqpart-{{forloop.counter}}-bin_id" value="{{reqpart.location_from__id}}" readonly="readonly"></td>
                                <td><input type="text" class="form-control" id="reqpart-{{forloop.counter}}-bin_loc" value="{{reqpart.location_from__bin_location}}" readonly="readonly"></td>
                                <td><input type="text" class="form-control" id="reqpart-{{forloop.counter}}-ass_id" value="{{reqpart.location_to__id}}" readonly="readonly"></td>
                                <td><input type="text" class="form-control" id="reqpart-{{forloop.counter}}-ass_line" value="{{reqpart.location_to__name}}" readonly="readonly"></td>
                            </tr>
                        </div>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header card-header-tabs card-header-info">
            <h4 class="card-title">Receive Part Request Issuance:</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped w-auto" id="recpart_table">
                    <thead class="thead-dark">
                        <tr class="tablehead">
                            <th scope="col">Prod Sched ID</th>
                            <th scope="col">Item Number</th>
                            <th scope="col">Date Received</th>
                            <th scope="col">Received Quantity</th>
                            <th scope="col">Bin Location ID</th>
                            <th scope="col">Bin Location</th>
                            <th scope="col">Assembly Line ID</th>
                            <th scope="col">Assembly Line</th>
                            <th scope="col">Notes</th>
                            <th scope="col">Required Quantity</th>
                            <th scope="col">Delete</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ partreq_recitem.management_form }}
                        {% for formsetitem in partreq_recitem %}
                        <div class="row form-row">
                            <tr class="tablerow recpart">
                                <td><input type="text" name="formsetitem-0-prod_sched" class="form-control" id="id_formsetitem-0-prod_sched" value="" readonly="readonly"></td>
                                <td><input type="text" name="formsetitem-0-item_number" class="form-control" id="id_formsetitem-0-item_number" value="" readonly="readonly"></td>
                                <td><input type="text" name="formsetitem-0-date_received" class="form-control" id="id_formsetitem-0-date_received" value="" readonly="readonly"></td>
                                <td><input type="text" name="formsetitem-0-rec_quantity" class="form-control" id="id_formsetitem-0-rec_quantity" value="" readonly="readonly"></td>
                                <td><input type="text" name="formsetitem-0-bin_location" class="form-control" id="id_formsetitem-0-bin_location" value="" readonly="readonly"></td>
                                <td><input type="text" name="formsetitem-{{forloop.counter0}}-bin_locationTEXT" class="form-control" id="id_formsetitem-{{forloop.counter0}}-bin_locationTEXT" value="" readonly="readonly"></td>
                                <td><input type="text" name="formsetitem-0-ass_location" class="form-control" id="id_formsetitem-0-ass_location" value="" readonly="readonly"></td>
                                <td><input type="text" name="formsetitem-{{forloop.counter0}}-ass_locationTEXT" class="form-control" id="id_formsetitem-{{forloop.counter0}}-ass_locationTEXT" value="" readonly="readonly"></td>
                                <td><input type="text" name="formsetitem-0-notes" class="form-control" id="id_formsetitem-0-notes" value="" readonly="readonly"></td>
                                <td><input type="text" name="formsetitem-{{forloop.counter0}}-req_quan" class="form-control" id="id_formsetitem-{{forloop.counter0}}-req_quan" value="" readonly="readonly"></td>
                                <td><button class="btn btn-success add-form-row">+</button></td>
                            </tr>
                        </div>
                        {% endfor %}

                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header card-header-tabs card-header-info">
            <h4 class="card-title">Component Request Issuance Summary:</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped w-auto" id="sum_table">
                    <thead class="thead-dark">
                        <tr class="tablehead">
                            <th scope="col">Prod Sched ID</th>
                            <th scope="col">Item Number</th>
                            <th scope="col">Total Required Quantity</th>
                            <th scope="col">Total Received Quantity</th>
                            <th scope="col">Discrepancy</th>
                            <th scope="col">Discrepancy Quantity</th>
                            <th scope="col">Status</th>
                            <th scope="col">Bin Location ID</th>
                            <th scope="col">Bin Location</th>
                            <th scope="col">Assembly Line ID</th>
                            <th scope="col">Assembly Line</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ partreq_summary.management_form }}
                        {% for formsetsummary in partreq_summary %}
                        <div class="row form-row">
                            <tr class="tablerow sum" id="id_formsetsummary-">
                                <td><input type="text" name="formsetsummary-0-prod_sched" class="form-control" id="id_formsetsummary-0-prod_sched" value="" readonly="readonly"></td>

                                <td><input type="text" name="formsetsummary-0-item_number" class="form-control" id="id_formsetsummary-0-item_number" value="" readonly="readonly"></td>
                                
                                <td><input type="text" name="formsetsummary-0-totalreq_quan" class="form-control" id="id_formsetsummary-0-totalreq_quan" value="" readonly="readonly"></td>

                                <td><input type="text" name="formsetsummary-0-totalrec_quan" class="form-control" id="id_formsetsummary-0-totalrec_quan" value="" readonly="readonly"></td>
                                <td><input type="text" name="formsetsummary-0-discrepancy" class="form-control" id="id_formsetsummary-0-discrepancy" value="" readonly="readonly"></td>

                                <td><input type="text" name="formsetsummary-0-discrepancy_quantity" class="form-control" id="id_formsetsummary-0-discrepancy_quantity" value="" readonly="readonly"></td>
                                
                                <td><input type="text" name="formsetsummary-0-status" class="form-control" id="id_formsetsummary-0-status" value="" readonly="readonly"></td>

                                <td><input type="text" name="formsetsummary-0-bin_location" class="form-control" id="id_formsetsummary-0-bin_location" value="" readonly="readonly"></td>

                                <td><input type="text" name="formsetsummary-0-bin_locationTEXT" class="form-control" id="id_formsetsummary-0-bin_locationTEXT" value="" readonly="readonly"></td>

                                <td><input type="text" name="formsetsummary-0-ass_location" class="form-control" id="id_formsetsummary-0-ass_location" value="" readonly="readonly"></td>

                                <td><input type="text" name="formsetsummary-0-ass_locationTEXT" class="form-control" id="id_formsetsummary-0-ass_locationTEXT" value="" readonly="readonly"></td>
                            </tr>
                        </div>
                        {% endfor %}

                    </tbody>
                </table>
            </div>
            <div class="form-row align-items-center">
                <div class="col-lg-2">
            <button type="submit" class="btn btn-block btn-success">Finish</button>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script type="text/javascript">
    $(document).ready(function(){
        $('#reqpart_table').find('tr.tablerow.part').each(function (i, el) {
                $(this).hide();
        });
    
    });

    function updateElementIndex(el, prefix, ndx) {
        var id_regex = new RegExp('(' + prefix + '-\\d+)');
        var replacement = prefix + '-' + ndx;
        if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
        if (el.id) el.id = el.id.replace(id_regex, replacement);
        if (el.name) el.name = el.name.replace(id_regex, replacement);
    }

    function cloneMore(prefix, prod_sched, item_num, date_rec, rec_quan, bin_id, bin_loc, ass_id,  ass_line, notes, req_quan) { //selector - .form-row:last | prefix - form
        var lastrowtbl = $('#recpart_table tr.tablerow.recpart:last').clone(true);
        var total = $('#id_' + prefix + '-TOTAL_FORMS').val();
        var currentnum = total - 1
        var counter = 0

        $('#recpart_table tr.tablerow.recpart:last').find('input[type=text]').each(function (i, el) {
            var name = $(this).attr('name');
            if(name) {
                if (counter === 0){
                    $(this).val(prod_sched);
                    counter++;
                } else if(counter === 1){
                    $(this).val(item_num);
                    counter++;
                }else if(counter === 2){
                    $(this).val(date_rec);
                    counter++;
                }else if(counter === 3){
                    $(this).val(rec_quan);
                    counter++;
                }else if(counter === 4){
                    $(this).val(bin_id);
                    counter++;
                }else if(counter === 5){
                    $(this).val(bin_loc);
                    counter++;
                }else if(counter === 6){
                    $(this).val(ass_id);
                    counter++;
                }else if(counter === 7){
                    $(this).val(ass_line);
                    counter++;
                }else if(counter === 8){
                    $(this).val(notes);
                    counter++;
                }else {
                    $(this).val(req_quan);
                    counter++;
                }
            }
        });           

        lastrowtbl.find('input[type=text]').each(function (i, el) {
            var name = $(this).attr('name');
            if(name) {
                name = name.replace('-' + currentnum + '-', '-' + total + '-');
                var id = 'id_' + name;
                $(this).attr({'name' : name, 'id' : id}).val('').removeAttr('checked');
            }
        });

        total++;
        $('#id_' + prefix + '-TOTAL_FORMS').val(total);
        $('#recpart_table tr.tablerow.recpart:last').after(lastrowtbl);

        var conditionRow = $('#recpart_table tr.tablerow.recpart:not(:last)');
        conditionRow.find('.btn.add-form-row')
        .removeClass('btn-success').addClass('btn-danger')
        .removeClass('add-form-row').addClass('remove-form-row')
        .html('-');

        checkExistingSum(prod_sched, item_num, req_quan, rec_quan, bin_id, bin_loc, ass_id, ass_line);

        return false;
    }

    function checkExistingSum(prod_sched, item_num, req_quan, rec_quan, bin_id, bin_loc, ass_id, ass_line){
        var total = $('#id_formsetsummary-TOTAL_FORMS').val();
        var lastrow = total - 1;
        counter = 0

        $('#sum_table').find('tr.tablerow.sum').each(function (i, el) {
            console.log(this);
            if( counter < lastrow ){
                var sumrow = this;
                var id = sumrow.id;

                var sum_itemnum = $('#'+id+counter+"-item_num").val();

                if(item_num === sum_itemnum){
                    var totalrec_quan = parseInt($('#'+id+counter+"-totalrec_quan").val());
                    var totalreq_quan = parseInt($('#'+id+counter+"-totalreq_quan").val());
                    totalrec_quan += parseInt(rec_quan);

                    var status = '' 
                    var disc = false;
                    var discQuan = totalreq_quan - totalrec_quan;
                    if(discQuan === 0){ //Non-issue
                        disc = false;
                        status = 'Non-Issue';
                    }else if (discQuan > 0){//Short-Shipped
                        disc = true;
                        status = 'Short-Shipped';
                    }else {//Over-Shipped
                         disc = true;
                        status = 'Over-Shipped';
                    }
                    $('#'+id+counter+"-totalrec_quan").val(totalrec_quan);
                    $('#'+id+counter+"-discrepancy").val(disc);
                    $('#'+id+counter+"-discrepancy_quantity").val(discQuan);
                    $('#'+id+counter+"-status").val(status);
                    return false;
                }

            }else{
                dosummary('formsetsummary', prod_sched, item_num, req_quan, rec_quan, bin_id, bin_loc, ass_id, ass_line);
            }
            counter++;
        });
    }

    function get_totreq(item_num){
        var req_item_num = 0;
        var req_itemreq_quan = 0;
                
        $('#reqpart_table').find('tr.tablerow.part').each(function (i, el) {
            if($(this).is(":visible")){
                console.log(this);
                var req_itemrow = this;
                req_item_num = req_itemrow.dataset.item_num;

                if(item_num === req_item_num){
                    req_itemreq_quan += parseInt(req_itemrow.dataset.req_quan);
                }
            }
        });

        return req_itemreq_quan;
    }



    function dosummary(prefix, prod_sched, item_num, req_quan, rec_quan, bin_id, bin_loc, ass_id, ass_line) {
        $('#sum_table tr.tablerow.sum:last').show();
        var lastrowtbl = $('#sum_table tr.tablerow.sum:last').clone(true);
        var total = $('#id_' + prefix + '-TOTAL_FORMS').val();
        var currentnum = total - 1;
        var counter = 0;

        var status = '' 
        var disc = false;
        var discQuan = parseInt(req_quan) - parseInt(rec_quan);
            if(discQuan === 0){ //Non-issue
                disc = false;
                status = 'Non-Issue';
            }else if (discQuan > 0){//Short-Shipped
                disc = true;
                status = 'Short-Shipped';
            }else {//Over-Shipped
                disc = true;
                status = 'Over-Shipped';
            }

        $('#sum_table tr.tablerow.sum:last').find('input[type=text]').each(function (i, el) {
            var name = $(this).attr('name');
            if(name) {
                if (counter === 0){
                    $(this).val(prod_sched);
                    counter++;
                } else if(counter === 1){
                    $(this).val(item_num);
                    counter++;
                } else if(counter === 2){
                    $(this).val(req_quan);
                    counter++;
                } else if(counter === 3){
                    $(this).val(rec_quan);
                    counter++;
                }else if(counter === 4){
                    $(this).val(disc);
                    counter++;
                }else if(counter === 5){
                    $(this).val(discQuan);
                    counter++;
                }else if(counter === 6){
                    $(this).val(status);
                    counter++;
                }else if(counter === 7){
                    $(this).val(bin_id);
                    counter++;
                }else if(counter === 8){
                    $(this).val(bin_loc);
                    counter++;
                }else if(counter === 9){
                    $(this).val(ass_id);
                    counter++;
                }else {
                    $(this).val(ass_line);
                    counter++;
                }
            }
        });

        lastrowtbl.find('input[type=text]').each(function (i, el) {
            var name = $(this).attr('name');
            if(name) {
                name = name.replace('-' + currentnum + '-', '-' + total + '-');
                var id = 'id_' + name;
                $(this).attr({'name' : name, 'id' : id}).val('').removeAttr('checked');
            }
        });

        total++;
        $('#id_' + prefix + '-TOTAL_FORMS').val(total);
        $('#sum_table tr.tablerow.sum:last').after(lastrowtbl);
        $('#sum_table tr.tablerow.sum:last').hide();

        return false;
    }

    function deleteForm(prefix, btn) {
        var total = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
        if (total > 1){
            btn.closest('#recpart_table tr.tablerow.recpart').remove();
            var forms = $('#recpart_table tr.tablerow.recpart');
            $('#id_' + prefix + '-TOTAL_FORMS').val(forms.length);

            for (var i=0, formCount=forms.length; i<formCount; i++) {

                $(forms.get(i)).find(':input[type=text]').each(function() {
                    updateElementIndex(this, prefix, i);
                });

            }
            total--;
            $('#id_' + prefix + '-TOTAL_FORMS').val(total);
        }
        return false;
    }

    function showreqitem(schednum){
        $('#reqpart_table').find('tr.tablerow.part').each(function (i, el) {
            var bomrow = this;
            var bom_sched_num = bomrow.dataset.sched_num;
                    
            if (bom_sched_num === schednum){
                $(this).show();
            }else {
                $(this).hide();
            }
        });
    }

    $(document).on('click', '.add-form-row', function(e){
        var prodsched = $("#partreqissuesched").val();
        var itemurl = "/SelectPartReqItem/";
        var windowurl = prodsched+itemurl;
        var wewewe = window.open(windowurl);
        return false;
    });

    $(document).on('click', '.add-partreqissuesched', function(e){
        var newwin = window.open("{% url 'warehouse:FinishPartReqIssuance_SelectPartReqSched' %}");
        return false;
    });
    
    $(document).on('click', '.remove-form-row', function(e){
        e.preventDefault();
        deleteForm('formsetitem', $(this));
        return false;
    });

</script>
{% endblock javascripts %}